рЃФрЃљрЃџрЃўрЃљрЃю рЃЎрЃљрЃарЃњрЃў рЃЎрЃўрЃЌрЃ«рЃЋрЃљ Рђћ рЃћрЃА рЃбрЃћрЃарЃЏрЃўрЃюрЃў рЃ«рЃерЃўрЃарЃљрЃЊ рЃњрЃЋрЃ«рЃЋрЃЊрЃћрЃЉрЃљ рЃЊрЃўрЃАрЃбрЃарЃўрЃЉрЃБрЃфрЃўрЃБрЃџ рЃАрЃўрЃАрЃбрЃћрЃЏрЃћрЃЉрЃАрЃљ рЃЊрЃљ caching/locking рЃЌрЃћрЃЏрЃћрЃЉрЃерЃў.  
рЃЏрЃЮрЃЎрЃџрЃћрЃЊ ­ЪЉЄ

---

### ­ЪњА **рЃЎрЃЮрЃџрЃўрЃќрЃўрЃљ (Collision)** Рђћ рЃћрЃА рЃљрЃарЃўрЃА рЃАрЃўрЃбрЃБрЃљрЃфрЃўрЃљ, рЃарЃЮрЃфрЃљ **рЃЮрЃарЃў рЃњрЃљрЃюрЃАрЃ«рЃЋрЃљрЃЋрЃћрЃЉрЃБрЃџрЃў рЃЮрЃърЃћрЃарЃљрЃфрЃўрЃљ рЃўрЃДрЃћрЃюрЃћрЃЉрЃА рЃћрЃарЃЌрЃАрЃљ рЃЊрЃљ рЃўрЃЏрЃљрЃЋрЃћ рЃўрЃЊрЃћрЃюрЃбрЃўрЃцрЃўрЃЎрЃљрЃбрЃЮрЃарЃА рЃљрЃю рЃарЃћрЃАрЃБрЃарЃАрЃА рЃБрЃюрЃћрЃЉрЃџрЃўрЃћрЃЊ**.

рЃљрЃюрЃБ рЃАрЃўрЃАрЃбрЃћрЃЏрЃљрЃЏ рЃЋрЃћрЃа рЃњрЃљрЃљрЃарЃЕрЃўрЃљ, рЃарЃЮрЃЏ рЃћрЃА рЃЮрЃЉрЃўрЃћрЃЦрЃбрЃћрЃЉрЃў рЃарЃћрЃљрЃџрЃБрЃарЃљрЃЊ рЃњрЃљрЃюрЃАрЃ«рЃЋрЃљрЃЋрЃћрЃЉрЃБрЃџрЃўрЃљ Рђћ рЃерЃћрЃЊрЃћрЃњрЃљрЃЊ рЃ«рЃЊрЃћрЃЉрЃљ **рЃЊрЃљрЃбрЃЎрЃћрЃфрЃљ рЃљрЃю рЃЮрЃарЃЏрЃљрЃњрЃў рЃЉрЃџрЃЮрЃЎрЃўрЃарЃћрЃЉрЃљ**, рЃарЃљрЃф рЃўрЃгрЃЋрЃћрЃЋрЃА рЃерЃћрЃфрЃЊрЃЮрЃЏрЃћрЃЉрЃА, рЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃЌрЃљ рЃЊрЃљрЃЎрЃљрЃарЃњрЃЋрЃљрЃА рЃљрЃю race condition-рЃА.

---

### ­ЪД▒ **рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃў Redis Lock-рЃќрЃћ**

рЃерЃћрЃюрЃў рЃЎрЃЮрЃЊрЃўрЃЊрЃљрЃю:

```csharp
await redis.TryAcquireLockAsync(evt.UserId, "processing", RedisLockTtl);
```

рЃЌрЃБ рЃЮрЃарЃў рЃАрЃ«рЃЋрЃљрЃЊрЃљрЃАрЃ«рЃЋрЃљ рЃЏрЃЮрЃЊрЃБрЃџрЃў (рЃЏрЃљрЃњ.  
`UserValidationBackgroundService` рЃЊрЃљ `UserActivationBackgroundService`)  
рЃЮрЃарЃўрЃЋрЃћрЃЏ рЃАрЃфрЃљрЃЊрЃљ lock рЃерЃћрЃЦрЃЏрЃюрЃљ рЃћрЃарЃЌрЃАрЃљ рЃЊрЃљ рЃўрЃЏрЃљрЃЋрЃћ `UserId`-рЃќрЃћ,  
рЃЮрЃарЃўрЃЋрЃћ рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћрЃЉрЃА рЃћрЃарЃЌрЃАрЃљ рЃЊрЃљ рЃўрЃЏрЃљрЃЋрЃћ Redis key-рЃА Рђћ рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃљрЃЊ:

```
Lock key: 12345
```

­ЪЉЅ рЃерЃћрЃЊрЃћрЃњрЃљрЃЊ Рђћ  
рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃАрЃћрЃарЃЋрЃўрЃАрЃў рЃЕрЃљрЃЎрЃћрЃбрЃљрЃЋрЃА рЃўрЃБрЃќрЃћрЃарЃА РђюрЃњрЃљрЃњрЃќрЃљрЃЋрЃюрЃљрЃќрЃћРђЮ,  
рЃЊрЃљ рЃЏрЃћрЃЮрЃарЃћ рЃАрЃћрЃарЃЋрЃўрЃАрЃў рЃЋрЃћрЃа рЃЊрЃљрЃўрЃгрЃДрЃћрЃЉрЃА рЃЌрЃљрЃЋрЃўрЃА рЃърЃарЃЮрЃфрЃћрЃАрЃА, рЃЌрЃўрЃЌрЃЦрЃЮрЃА рЃћрЃА рЃўрЃњрЃўрЃЋрЃћ рЃЮрЃърЃћрЃарЃљрЃфрЃўрЃљрЃљ.

рЃћрЃАрЃљрЃљ **рЃЎрЃЮрЃџрЃўрЃќрЃўрЃљ** Рђћ рЃарЃЮрЃфрЃљ рЃЮрЃарЃў рЃЊрЃљрЃЏрЃЮрЃБрЃЎрЃўрЃЊрЃћрЃЉрЃћрЃџрЃў рЃърЃарЃЮрЃфрЃћрЃАрЃўрЃА рЃўрЃЊрЃћрЃюрЃбрЃўрЃцрЃўрЃЎрЃљрЃбрЃЮрЃарЃў рЃћрЃЏрЃЌрЃ«рЃЋрЃћрЃЋрЃљ.

---

### ­ЪДЕ **рЃарЃЮрЃњрЃЮрЃа рЃЋрЃљрЃАрЃгрЃЮрЃарЃћрЃЉрЃЌ**

рЃАрЃгрЃЮрЃарЃљрЃЊ рЃарЃЮрЃЏ рЃљрЃЋрЃўрЃарЃўрЃЊрЃЮрЃЌ рЃЎрЃЮрЃџрЃўрЃќрЃўрЃљ, рЃЋрЃБрЃЎрЃћрЃЌрЃћрЃЉрЃЌ **namespace prefix-рЃА**, рЃљрЃюрЃБ рЃБрЃюрЃўрЃЎрЃљрЃџрЃБрЃа рЃЎрЃЮрЃюрЃбрЃћрЃЦрЃАрЃбрЃА:

```csharp
await redis.TryAcquireLockAsync($"user-validation:{evt.UserId}", "processing", RedisLockTtl);
```

рЃљрЃ«рЃџрЃљ Redis-рЃерЃў рЃЕрЃљрЃћрЃгрЃћрЃарЃћрЃЉрЃљ:

```
Lock key: user-validation:12345
```

рЃЊрЃљ рЃАрЃ«рЃЋрЃљ рЃАрЃћрЃарЃЋрЃўрЃАрЃў (рЃЏрЃљрЃњ. Рђюuser-activationРђЮ) рЃЌрЃБ рЃўрЃЏрЃљрЃЋрЃћ рЃўрЃБрЃќрЃћрЃарЃќрЃћ рЃўрЃЏрЃБрЃерЃљрЃЋрЃћрЃЉрЃА, рЃЕрЃљрЃгрЃћрЃарЃА:

```
Lock key: user-activation:12345
```

­ЪЉЅ рЃљрЃАрЃћ рЃЌрЃљрЃЋрЃўрЃЊрЃљрЃю рЃљрЃЋрЃўрЃарЃўрЃЊрЃћрЃЉрЃЌ рЃћрЃарЃЌрЃЏрЃљрЃюрЃћрЃЌрЃўрЃА рЃњрЃљрЃЊрЃљрЃцрЃљрЃарЃЋрЃљрЃА (collision).

---

### ­ЪДГ **рЃАрЃљрЃЊ рЃњрЃЋрЃ«рЃЋрЃЊрЃћрЃЉрЃљ рЃЎрЃЮрЃџрЃўрЃќрЃўрЃљ рЃърЃарЃљрЃЦрЃбрЃўрЃЎрЃљрЃерЃў**

- Redis key-рЃћрЃЉрЃерЃў (lock, cache, counter)
    
- Hash рЃцрЃБрЃЦрЃфрЃўрЃћрЃЉрЃерЃў (рЃЏрЃљрЃњ. dictionary collisions)
    
- Primary key рЃљрЃю unique constraint рЃЊрЃљрЃарЃдрЃЋрЃћрЃЋрЃўрЃАрЃљрЃА
    
- Message queue-рЃерЃў, рЃарЃЮрЃфрЃљ рЃЮрЃарЃў consumer рЃўрЃДрЃћрЃюрЃћрЃЉрЃА рЃўрЃЏрЃљрЃЋрЃћ message-id-рЃА
    

---
