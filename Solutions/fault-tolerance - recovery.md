рЃФрЃљрЃџрЃўрЃљрЃю рЃЎрЃљрЃарЃњрЃў рЃЎрЃўрЃЌрЃ«рЃЋрЃљ Рђћ рЃљрЃюрЃБ:  
­ЪЉЅ _рЃарЃљ рЃЏрЃЮрЃ«рЃЊрЃћрЃЉрЃљ, рЃЌрЃБ Redis-рЃерЃў рЃЕрЃљрЃЋрЃгрЃћрЃарЃћ lock ("processing"), рЃЏрЃљрЃњрЃарЃљрЃЏ рЃњрЃљрЃњрЃќрЃљрЃЋрЃюрЃљ (`SendEventToExternalService`) рЃЋрЃћрЃа рЃЏрЃЮрЃ«рЃћрЃарЃ«рЃЊрЃљ рЃљрЃю рЃљрЃърЃџрЃўрЃЎрЃљрЃфрЃўрЃљ рЃњрЃљрЃўрЃЌрЃўрЃерЃљ / рЃЊрЃљрЃўрЃЎрЃарЃљрЃерЃљ?_

рЃћрЃА рЃљрЃарЃўрЃА рЃЎрЃџрЃљрЃАрЃўрЃЎрЃБрЃарЃў **fault-tolerance / recovery** рЃАрЃљрЃЎрЃўрЃЌрЃ«рЃў idempotent background job-рЃћрЃЉрЃерЃў.  
рЃЏрЃЮрЃЊрЃў рЃљрЃЋрЃ«рЃАрЃюрЃљрЃЌ рЃџрЃЮрЃњрЃўрЃЎрЃБрЃарЃљрЃЊ рЃЊрЃљ рЃърЃарЃљрЃЦрЃбрЃўрЃЎрЃБрЃџрЃљрЃЊ ­ЪЉЄ

---

## ­ЪњЦ рЃАрЃфрЃћрЃюрЃљрЃарЃў Рђћ рЃњрЃљрЃњрЃќрЃљрЃЋрЃюрЃљ рЃЋрЃћрЃа рЃЏрЃЮрЃ«рЃћрЃарЃ«рЃЊрЃљ

|рЃћрЃбрЃљрЃърЃў|рЃЦрЃЏрЃћрЃЊрЃћрЃЉрЃљ|рЃерЃћрЃЊрЃћрЃњрЃў|
|---|---|---|
|1№ИЈРЃБ|Redis-рЃерЃў рЃЊрЃљрЃўрЃгрЃћрЃарЃљ `"safehome:user_event:{UserId}" = processing`|рЃАрЃ«рЃЋрЃљ рЃърЃарЃЮрЃфрЃћрЃАрЃћрЃЉрЃў рЃљрЃЏ рЃўрЃЋрЃћрЃюрЃЌрЃА рЃљрЃдрЃљрЃа рЃерЃћрЃћрЃ«рЃћрЃЉрЃўрЃљрЃю|
|2№ИЈРЃБ|External API (`SendEventToExternalService`) рЃЕрЃљрЃўрЃГрЃарЃљ рЃљрЃю рЃљрЃърЃў рЃњрЃљрЃўрЃЌрЃўрЃерЃљ|Redis lock рЃЊрЃљрЃарЃЕрЃљ РђъprocessingРђю рЃЏрЃЊрЃњрЃЮрЃЏрЃљрЃарЃћрЃЮрЃЉрЃљрЃерЃў|
|3№ИЈРЃБ|рЃерЃћрЃЏрЃЊрЃћрЃњ iteration-рЃќрЃћ рЃўрЃЋрЃћрЃюрЃЌрЃў рЃўрЃАрЃћрЃЋ Pending рЃљрЃарЃўрЃА DB-рЃерЃў, рЃЏрЃљрЃњрЃарЃљрЃЏ Redis-рЃерЃў рЃ»рЃћрЃа рЃЎрЃўрЃЊрЃћрЃЋ РђюрЃЊрЃљрЃЉрЃџрЃЮрЃЎрЃўрЃџрЃўрЃљРђЮ|Job рЃњрЃљрЃЏрЃЮрЃбрЃЮрЃЋрЃћрЃЉрЃА рЃЏрЃўрЃА рЃњрЃљрЃњрЃќрЃљрЃЋрЃюрЃљрЃА рЃЊрЃарЃЮрЃћрЃЉрЃўрЃЌ|

---

## ­ЪЋњ рЃљрЃЏрЃўрЃбрЃЮрЃЏ рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ **Expiry (TimeSpan)** Redis lock-рЃќрЃћ

рЃарЃЮрЃЊрЃћрЃАрЃљрЃф рЃЦрЃЏрЃюрЃў lock-рЃА:

```csharp
await redisService.SetEventPendingAsync(userObj.UserId, "processing", TimeSpan.FromMinutes(15));
```

рЃћрЃА рЃюрЃўрЃерЃюрЃљрЃЋрЃА:

> рЃЌрЃБ 15 рЃгрЃБрЃЌрЃерЃў рЃљрЃарЃљрЃцрЃћрЃарЃў рЃерЃћрЃўрЃфрЃЋрЃљрЃџрЃљ, Redis рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃгрЃљрЃерЃџрЃўрЃА рЃљрЃЏ key-рЃА.

рЃљрЃЏрЃўрЃбрЃЮрЃЏ Рђћ  
рЃЌрЃБ рЃњрЃљрЃњрЃќрЃљрЃЋрЃюрЃљ рЃЕрЃљрЃўрЃГрЃарЃљ рЃљрЃю рЃАрЃћрЃарЃЋрЃўрЃАрЃў рЃЊрЃљрЃћрЃфрЃљ, 15 рЃгрЃБрЃЌрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ Redis lock рЃњрЃљрЃЦрЃарЃћрЃЉрЃљ  
рЃЊрЃљ рЃерЃћрЃЏрЃЊрЃћрЃњ iteration рЃўрЃАрЃћрЃЋ рЃљрЃўрЃдрЃћрЃЉрЃА рЃўрЃЏрЃљрЃЋрЃћ рЃўрЃЋрЃћрЃюрЃЌрЃА (DB-рЃерЃў рЃ«рЃЮрЃЏ рЃўрЃАрЃћрЃЋ Pending рЃўрЃЦрЃюрЃћрЃЉрЃљ).

РюЁ рЃљрЃАрЃћ рЃЏрЃўрЃўрЃдрЃгрЃћрЃЋрЃљ **self-healing retry** рЃЏрЃћрЃЦрЃљрЃюрЃўрЃќрЃЏрЃў Рђћ  
рЃЊрЃарЃЮрЃћрЃЉрЃўрЃЌ рЃЊрЃљрЃЉрЃџрЃЮрЃЎрЃћ, рЃЏрЃљрЃњрЃарЃљрЃЏ рЃЌрЃБ рЃЋрЃћрЃа рЃЊрЃљрЃљрЃЏрЃЌрЃљрЃЋрЃарЃћ, рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃњрЃљрЃЌрЃљрЃЋрЃўрЃАрЃБрЃцрЃџрЃЊрЃћрЃЉрЃљ.

---

## РюЁ рЃАрЃарЃБрЃџрЃў Retry рЃфрЃўрЃЎрЃџрЃў рЃЏрЃБрЃерЃљрЃЮрЃЉрЃА рЃљрЃАрЃћ

1. рЃўрЃЋрЃћрЃюрЃЌрЃў DB-рЃерЃў = `Pending`
    
2. Worker рЃўрЃдрЃћрЃЉрЃА Рєњ рЃљрЃЏрЃљрЃбрЃћрЃЉрЃА Redis lock `"processing"`
    
3. рЃљрЃњрЃќрЃљрЃЋрЃюрЃўрЃА API-рЃА
    
    - рЃЌрЃБ **рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ** Рєњ DB status = `Sent`, Redis key рЃгрЃљрЃўрЃерЃџрЃћрЃЉрЃљ
        
    - рЃЌрЃБ **рЃЕрЃљрЃўрЃГрЃарЃљ** Рєњ Redis lock рЃЊрЃљрЃарЃЕрЃћрЃЉрЃљ `processing`, рЃЏрЃљрЃњрЃарЃљрЃЏ **15 рЃгрЃБрЃЌрЃерЃў рЃљрЃЏрЃЮрЃўрЃгрЃБрЃарЃћрЃЉрЃљ**
        
4. рЃерЃћрЃЏрЃЊрЃћрЃњ рЃфрЃўрЃЎрЃџрЃќрЃћ worker рЃўрЃАрЃћрЃЋ рЃерЃћрЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА Pending рЃўрЃЋрЃћрЃюрЃЌрЃћрЃЉрЃА  
    рЃЊрЃљ Redis-рЃўрЃА key рЃБрЃЎрЃЋрЃћ рЃгрЃљрЃерЃџрЃўрЃџрЃў рЃўрЃЦрЃюрЃћрЃЉрЃљ Рєњ **рЃњрЃљрЃљрЃњрЃарЃФрЃћрЃџрЃћрЃЉрЃА resend-рЃА**
    

---

## ­Ъџђ Best Practice Рђћ Retry Counter (рЃњрЃљрЃБрЃЏрЃ»рЃЮрЃЉрЃћрЃАрЃћрЃЉрЃБрЃџрЃў рЃЋрЃћрЃарЃАрЃўрЃљ)

рЃерЃћрЃњрЃўрЃФрЃџрЃўрЃљ Redis-рЃерЃў рЃерЃћрЃўрЃюрЃљрЃ«рЃЮ рЃљрЃарЃљ рЃБрЃЉрЃарЃљрЃџрЃЮрЃЊ `"processing"`, рЃљрЃарЃљрЃЏрЃћрЃЊ retry counter:

```csharp
await _db.StringSetAsync($"safehome:user_event:{eventId}", "attempt:1", expiry: TimeSpan.FromMinutes(15));
```

рЃерЃћрЃЏрЃЊрЃћрЃњ рЃЌрЃБ рЃњрЃљрЃњрЃќрЃљрЃЋрЃюрЃљ рЃЕрЃљрЃўрЃГрЃарЃљ, рЃњрЃљрЃќрЃљрЃарЃЊрЃћ counter:

```csharp
await _db.StringIncrementAsync($"safehome:user_event:{eventId}");
```

рЃЊрЃљ рЃЌрЃБ counter рЃЏрЃўрЃљрЃдрЃгрЃћрЃЋрЃА 3-рЃА Рєњ  
DB-рЃерЃў рЃЏрЃЮрЃюрЃўрЃерЃюрЃћ рЃарЃЮрЃњрЃЮрЃарЃф `Failed`, рЃЊрЃљ рЃљрЃдрЃљрЃа retry.

рЃћрЃА рЃњрЃљрЃЏрЃЮрЃњрЃљрЃЊрЃњрЃћрЃЉрЃљ **Outbox + Redis Retry Pattern**-рЃерЃў,  
рЃАрЃљрЃЊрЃљрЃф рЃцрЃўрЃюрЃљрЃџрЃБрЃарЃў рЃерЃћрЃЊрЃћрЃњрЃћрЃЉрЃў рЃДрЃЮрЃЋрЃћрЃџрЃЌрЃЋрЃўрЃА рЃЌрЃљрЃюрЃ«рЃЋрЃћрЃЊрЃарЃљрЃерЃўрЃљ DB-рЃАрЃљ рЃЊрЃљ Redis-рЃА рЃерЃЮрЃарЃўрЃА.

---

## ­ЪДа рЃерЃћрЃ»рЃљрЃЏрЃћрЃЉрЃљ

|рЃерЃћрЃЏрЃЌрЃ«рЃЋрЃћрЃЋрЃљ|рЃЦрЃфрЃћрЃЋрЃљ|
|---|---|
|рЃњрЃљрЃњрЃќрЃљрЃЋрЃюрЃљ рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃБрЃџрЃў|DB `EventStatus = Sent`, Redis key рЃўрЃерЃџрЃћрЃЉрЃљ|
|рЃњрЃљрЃњрЃќрЃљрЃЋрЃюрЃљ рЃЕрЃљрЃЋрЃљрЃарЃЊрЃљ|Redis key рЃЊрЃљрЃарЃЕрЃћрЃЉрЃљ рЃЊрЃарЃЮрЃћрЃЉрЃўрЃЌ, рЃерЃћрЃЏрЃЊрЃћрЃњ рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃњрЃљрЃЦрЃарЃћрЃЉрЃљ Expiry-рЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ|
|рЃљрЃърЃџрЃўрЃЎрЃљрЃфрЃўрЃљ рЃњрЃљрЃўрЃЌрЃўрЃерЃљ|Redis key рЃЏрЃљрЃўрЃюрЃф рЃњрЃљрЃЦрЃарЃћрЃЉрЃљ Expiry-рЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ|
|Redis key рЃњрЃљрЃЦрЃарЃљ, DB-рЃерЃў рЃўрЃАрЃћрЃЋ Pending|Worker рЃўрЃАрЃћрЃЋ retry-рЃА рЃњрЃљрЃБрЃерЃЋрЃћрЃЉрЃА рЃўрЃЏрЃљрЃЋрЃћ рЃўрЃЋрЃћрЃюрЃЌрЃќрЃћ|

---

рЃЌрЃБ рЃњрЃўрЃюрЃЊрЃљ, рЃерЃћрЃњрЃўрЃЦрЃЏрЃюрЃў рЃњрЃљрЃЏрЃљрЃарЃЌрЃБрЃџ рЃЋрЃћрЃарЃАрЃўрЃљрЃА Retry Counter-рЃўрЃЌ (рЃЏрЃљрЃњ. 3-рЃ»рЃћрЃа рЃАрЃфрЃљрЃЊрЃЮрЃА, exponential delay-рЃўрЃЌ, рЃЊрЃљ рЃЉрЃЮрЃџрЃЮрЃА рЃЕрЃљрЃгрЃћрЃарЃЮрЃА DB-рЃерЃў `Failed`).  
рЃћрЃА рЃБрЃЎрЃЋрЃћ production-grade, fault-tolerant background рЃАрЃўрЃАрЃбрЃћрЃЏрЃљ рЃўрЃЦрЃюрЃћрЃЉрЃљ.  
