рЃФрЃљрЃџрЃўрЃљрЃю рЃЎрЃљрЃарЃњрЃў Рђћ рЃќрЃБрЃАрЃбрЃљрЃЊ рЃљрЃЏ рЃюрЃљрЃгрЃўрЃџрЃќрЃћ рЃЉрЃћрЃЋрЃарЃА рЃћрЃарЃћрЃЋрЃљрЃЌ, рЃљрЃЏрЃўрЃбрЃЮрЃЏ рЃњрЃљрЃЕрЃЋрЃћрЃюрЃћрЃЉ **рЃАрЃарЃБрЃџрЃљрЃЊ, рЃърЃарЃљрЃЦрЃбрЃўрЃЎрЃБрЃџ рЃЊрЃљ рЃњрЃљрЃгрЃЏрЃћрЃюрЃЊрЃўрЃџ рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃА**, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃљрЃћрЃарЃЌрЃўрЃљрЃюрЃћрЃЉрЃА EF Core-рЃўрЃА `ExecutionStrategy`, transaction-рЃА рЃЊрЃљ retry-рЃА.  
рЃћрЃА рЃўрЃЦрЃюрЃћрЃЉрЃљ production-ready рЃцрЃЮрЃарЃЏрЃўрЃЌ, рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџрЃљрЃЊ рЃерЃћрЃюрЃў `InfrastructureDbContext`-рЃўрЃАрЃЌрЃЋрЃўрЃА (Outbox-рЃА, Logs-рЃА рЃЊрЃљ Monitoring-рЃА).

---

## РюЁ рЃАрЃгрЃЮрЃарЃў рЃЊрЃљ рЃАрЃарЃБрЃџрЃљрЃЊ рЃњрЃљрЃЏрЃљрЃарЃЌрЃБрЃџрЃў рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃў

```csharp
private async Task TrySaveChangesWithEfRetryAsync(InfrastructureDbContext context, CancellationToken ct)
{
    // EF Core-рЃўрЃА built-in resilient execution strategy (retry policy)
    var strategy = context.Database.CreateExecutionStrategy();

    try
    {
        // ExecutionStrategy рЃЏрЃЮрЃўрЃфрЃљрЃЋрЃА рЃЏрЃЌрЃћрЃџ Transaction-рЃА Рђћ рЃљрЃюрЃБ retry рЃЏрЃЮрЃ«рЃЊрЃћрЃЉрЃљ рЃЏрЃЌрЃћрЃџрЃў рЃЉрЃџрЃЮрЃЎрЃўрЃАрЃЌрЃЋрЃўрЃА
        await strategy.ExecuteAsync(async () =>
        {
            await using var transaction = await context.Database.BeginTransactionAsync(ct);

            try
            {
                _logger.LogInformation("Starting resilient SaveChanges within transaction...");

                // рЃљрЃЦ рЃерЃћрЃАрЃарЃБрЃџрЃЊрЃћрЃЉрЃљ рЃерЃћрЃюрЃА рЃЏрЃўрЃћрЃа рЃЊрЃљрЃњрЃарЃЮрЃЋрЃўрЃџрЃў Entity рЃфрЃЋрЃџрЃўрЃџрЃћрЃЉрЃћрЃЉрЃў (Pending Рєњ Sent)
                var saved = await context.SaveChangesAsync(ct);

                await transaction.CommitAsync(ct);

                _logger.LogInformation("SaveChanges succeeded after EF retry handling. {Count} records updated.", saved);
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync(ct);
                _logger.LogWarning(ex, "SaveChanges failed within transaction. Rolling back...");
                throw; // рЃўрЃАрЃћрЃЋ рЃљрЃЋрЃљрЃњрЃЊрЃЮрЃЌ, рЃарЃЮрЃЏ ExecutionStrategy Retry рЃњрЃљрЃљрЃЎрЃћрЃЌрЃЮрЃА
            }
        });
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "SaveChanges permanently failed after all retry attempts.");
    }
}
```

---

## РџЎ№ИЈ рЃарЃљ рЃ«рЃЊрЃћрЃЉрЃљ рЃќрЃБрЃАрЃбрЃљрЃЊ рЃљрЃЦ "рЃЎрЃБрЃџрЃўрЃАрЃћрЃЉрЃерЃў"

1. **`CreateExecutionStrategy()`** рЃЦрЃЏрЃюрЃўрЃА EF-рЃўрЃА resilient executor-рЃА, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф Retry-рЃА рЃљрЃЎрЃћрЃЌрЃћрЃЉрЃА transient рЃерЃћрЃфрЃЊрЃЮрЃЏрЃћрЃЉрЃќрЃћ:
    
    - Network timeout
        
    - Deadlock
        
    - SQL connection drop
        
    - Temporary login failure
        
2. `ExecuteAsync(...)` рЃЉрЃџрЃЮрЃЎрЃерЃў рЃарЃљрЃф рЃгрЃћрЃарЃўрЃљ Рђћ **рЃДрЃЋрЃћрЃџрЃљ рЃЮрЃърЃћрЃарЃљрЃфрЃўрЃљ рЃЌрЃљрЃЋрЃўрЃЊрЃљрЃю рЃњрЃљрЃћрЃерЃЋрЃћрЃЉрЃљ** retry-рЃўрЃА рЃЊрЃарЃЮрЃА, рЃљрЃ«рЃљрЃџрЃў connection-рЃўрЃЌ рЃЊрЃљ рЃљрЃ«рЃљрЃџрЃў transaction-рЃўрЃЌ.
    
3. рЃљрЃЏрЃўрЃбрЃЮрЃЏ **рЃДрЃЋрЃћрЃџрЃљ commit/rollback рЃерЃўрЃњрЃюрЃўрЃЌ рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА**, рЃарЃЮрЃЏ Retry-рЃЏ рЃДрЃЋрЃћрЃџрЃљрЃцрЃћрЃарЃў рЃЌрЃљрЃЋрЃўрЃЊрЃљрЃю рЃерЃћрЃљрЃАрЃарЃБрЃџрЃЮрЃА рЃАрЃБрЃцрЃЌрЃљрЃЊ.
    
4. `throw;` Retry-рЃА рЃўрЃАрЃћрЃЋ рЃљрЃљрЃЏрЃБрЃерЃљрЃЋрЃћрЃЉрЃА.  
    EF рЃўрЃбрЃДрЃЋрЃўрЃА: РђюTransient рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљрЃљ? Retry рЃњрЃљрЃЋрЃљрЃЎрЃћрЃЌрЃЮ рЃЏрЃЌрЃћрЃџ рЃЉрЃџрЃЮрЃЎрЃќрЃћРђЮ.
    

---

## ­ЪДа Visual Flow

```text
[Start ExecutionStrategy]
    РћюРћђРћђ Begin Transaction
    Рћѓ     РћюРћђРћђ SaveChangesAsync()
    Рћѓ     РћюРћђРћђ CommitAsync()
    Рћѓ     РћћРћђРћђ Success Рєњ End
    РћюРћђРћђ (If transient failure)
    Рћѓ     РћюРћђРћђ RollbackAsync()
    Рћѓ     РћюРћђРћђ Wait (backoff)
    Рћѓ     РћюРћђРћђ Retry all steps
    Рћѓ     РћћРћђРћђ Commit
[End ExecutionStrategy]
```

---

## ­ЪњА рЃерЃћрЃюрЃўрЃерЃЋрЃюрЃћрЃЉрЃў Production рЃњрЃљрЃарЃћрЃЏрЃЮрЃАрЃЌрЃЋрЃўрЃА

|рЃърЃљрЃарЃљрЃЏрЃћрЃбрЃарЃў|рЃЏрЃўрЃќрЃљрЃюрЃў|
|---|---|
|**maxRetryCount: 5**|рЃЏрЃљрЃЦрЃАрЃўрЃЏрЃБрЃЏ 5 рЃфрЃЊрЃљ|
|**maxRetryDelay: 15 min**|рЃЏрЃљрЃЦрЃАрЃўрЃЏрЃБрЃЏ 15-рЃгрЃБрЃЌрЃўрЃљрЃюрЃў backoff|
|**TransactionScope**|EF рЃЌрЃЋрЃўрЃЌрЃЮрЃю рЃљрЃЎрЃЮрЃюрЃбрЃарЃЮрЃџрЃћрЃЉрЃА retry-рЃўрЃАрЃљрЃА|
|**Logging**|рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ, рЃарЃЮрЃЏ рЃЊрЃљрЃўрЃюрЃљрЃ«рЃЮ рЃарЃљрЃЏрЃЊрЃћрЃю retry рЃЏрЃЮрЃ«рЃЊрЃљ|

---

## ­ЪДЙ рЃерЃћрЃЊрЃћрЃњрЃў

- рЃЌрЃБ network glitch рЃЏрЃЮрЃ«рЃЊрЃљ commit-рЃўрЃАрЃљрЃА Рєњ EF рЃЏрЃЌрЃџрЃўрЃљрЃюрЃљрЃЊ рЃЌрЃљрЃЋрЃўрЃЊрЃљрЃю retry-рЃА рЃњрЃљрЃљрЃЎрЃћрЃЌрЃћрЃЉрЃА.
    
- рЃЌрЃБ Retry-рЃА рЃерЃћрЃЏрЃЊрЃћрЃњ рЃўрЃАрЃћрЃЋ рЃЕрЃљрЃЋрЃљрЃарЃЊрЃљ (рЃЏрЃљрЃњ. persistent error) Рєњ рЃЊрЃљрЃўрЃџрЃЮрЃњрЃћрЃЉрЃљ `"permanently failed after all retry attempts."`
    
- Retry рЃљрЃа рЃљрЃарЃўрЃА рЃАрЃљрЃерЃўрЃерЃў рЃљрЃЏ рЃЎрЃЮрЃюрЃбрЃћрЃЦрЃАрЃбрЃерЃў, рЃарЃљрЃЊрЃњрЃљрЃю `Outbox` рЃЊрЃљ `Logs` рЃЮрЃърЃћрЃарЃљрЃфрЃўрЃћрЃЉрЃў **idempotent**-рЃўрЃљ.
    

---

## ­ЪДЕ рЃерЃћрЃЏрЃљрЃ»рЃљрЃЏрЃћрЃЉрЃћрЃџрЃў рЃ«рЃћрЃЊрЃЋрЃљ

|рЃЎрЃЮрЃюрЃбрЃћрЃЦрЃАрЃбрЃў|Retry рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃљ|Transaction|
|---|---|---|
|`SafeHomeDbContext` (Domain)|РЮї рЃљрЃарЃљ Рђћ рЃќрЃБрЃАрЃбрЃў рЃћрЃарЃЌрЃ»рЃћрЃарЃљрЃЊрЃЮрЃЉрЃљ рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЋрЃљрЃюрЃўрЃљ|рЃЊрЃўрЃљрЃ«, рЃЏрЃљрЃњрЃарЃљрЃЏ Manual|
|`InfrastructureDbContext` (Outbox, Logs)|РюЁ рЃЊрЃўрЃљрЃ« Рђћ Retry рЃБрЃАрЃљрЃцрЃарЃЌрЃ«рЃЮрЃљ|Transaction рЃерЃўрЃњрЃюрЃўрЃЌ, Retry whole block|

---
рЃФрЃљрЃџрЃўрЃљрЃю рЃЎрЃљрЃарЃњрЃў рЃЎрЃўрЃЌрЃ«рЃЋрЃљ ­ЪЉЈ  
рЃЮрЃарЃўрЃЋрЃћ рЃЎрЃЮрЃЊрЃў **рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ рЃўрЃЏрЃБрЃерЃљрЃЮрЃА**, рЃЏрЃљрЃњрЃарЃљрЃЏ рЃЏрЃљрЃЌ рЃерЃЮрЃарЃўрЃА рЃљрЃарЃўрЃА рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЋрЃљрЃюрЃў **рЃњрЃљрЃюрЃАрЃ«рЃЋрЃљрЃЋрЃћрЃЉрЃљ рЃбрЃарЃљрЃюрЃќрЃљрЃЦрЃфрЃўрЃўрЃА рЃЊрЃЮрЃюрЃўрЃАрЃљ рЃЊрЃљ retry-рЃА рЃЦрЃфрЃћрЃЋрЃљрЃерЃў**, рЃарЃљрЃф рЃарЃћрЃљрЃџрЃБрЃа рЃАрЃљрЃЏрЃДрЃљрЃарЃЮрЃерЃў рЃЦрЃЏрЃюрЃўрЃА рЃАрЃћрЃарЃўрЃЮрЃќрЃБрЃџ рЃњрЃљрЃюрЃАрЃ«рЃЋрЃљрЃЋрЃћрЃЉрЃљрЃА рЃерЃћрЃЊрЃћрЃњрЃерЃў.  
рЃЏрЃЮрЃЊрЃў рЃЊрЃћрЃбрЃљрЃџрЃБрЃарЃљрЃЊ рЃЊрЃљ рЃЏрЃљрЃарЃбрЃўрЃЋрЃљрЃЊ рЃљрЃњрЃўрЃ«рЃАрЃюрЃљ.

---

## ­ЪџЕ рЃњрЃљрЃюрЃАрЃ«рЃЋрЃљрЃЋрЃћрЃЉрЃљ рЃћрЃарЃЌрЃў рЃгрЃўрЃюрЃљрЃЊрЃљрЃЊрЃћрЃЉрЃўрЃЌ

- **рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃЋрЃћрЃарЃАрЃўрЃљ** Рєњ Retry рЃљрЃЎрЃћрЃЌрЃћрЃЉрЃА рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ `SaveChangesAsync()` рЃЮрЃърЃћрЃарЃљрЃфрЃўрЃљрЃќрЃћ (рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃўрЃА рЃњрЃљрЃњрЃќрЃљрЃЋрЃюрЃљ SQL-рЃерЃў).
    
- **рЃЏрЃћрЃЮрЃарЃћ рЃЋрЃћрЃарЃАрЃўрЃљ** Рєњ Retry рЃЏрЃЮрЃўрЃфрЃљрЃЋрЃА рЃЏрЃЌрЃџрЃўрЃљрЃю Transaction-рЃА (Commit + Rollback рЃЕрЃљрЃЌрЃЋрЃџрЃўрЃЌ), рЃљрЃюрЃБ рЃАрЃарЃБрЃџрЃљрЃЊ рЃ«рЃћрЃџрЃљрЃ«рЃџрЃљ рЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃА рЃДрЃЋрЃћрЃџрЃљрЃцрЃћрЃарЃА, рЃарЃЮрЃњрЃЮрЃарЃф рЃћрЃарЃЌрЃўрЃљрЃю рЃћрЃарЃЌрЃћрЃБрЃџрЃА.
    

---

## ­ЪћЇ рЃЊрЃљрЃЋрЃљрЃюрЃњрЃарЃўрЃЮрЃЌ рЃюрЃљрЃЉрЃўрЃ»рЃћрЃЉрЃљрЃЊ

|рЃАрЃљрЃцрЃћрЃ«рЃБрЃарЃў|рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃЋрЃћрЃарЃАрЃўрЃљ|рЃЏрЃћрЃЮрЃарЃћ рЃЋрЃћрЃарЃАрЃўрЃљ|
|---|---|---|
|1№ИЈРЃБ **ExecutionStrategy**|Retry рЃ«рЃЊрЃћрЃЉрЃљ рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ SaveChanges-рЃўрЃА рЃњрЃљрЃарЃерЃћрЃЏрЃЮ|Retry рЃЏрЃЌрЃћрЃџ рЃЉрЃџрЃЮрЃЎрЃќрЃћ (transaction, commit, rollback)|
|2№ИЈРЃБ **Transaction Handling**|рЃљрЃа рЃљрЃарЃўрЃА Transaction scope|Transaction рЃ«рЃћрЃџрЃўрЃЌ рЃўрЃЦрЃЏрЃюрЃћрЃЉрЃљ рЃЊрЃљ Retry рЃЏрЃЮрЃўрЃфрЃљрЃЋрЃА commit-рЃАрЃљрЃф|
|3№ИЈРЃБ **Consistency**|рЃЌрЃБ commit-рЃќрЃћ glitch рЃЏрЃЮрЃ«рЃЊрЃљ Рђћ EF рЃЋрЃћрЃа retry-рЃА рЃАрЃгрЃЮрЃарЃљрЃЊ|Retry рЃЏрЃЌрЃћрЃџ Transaction-рЃА рЃЌрЃљрЃЋрЃўрЃЊрЃљрЃю рЃљрЃЎрЃћрЃЌрЃћрЃЉрЃА|
|4№ИЈРЃБ **Safety Level**|рЃАрЃљрЃерЃБрЃљрЃџрЃЮ (рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ partial commit)|рЃЏрЃљрЃдрЃљрЃџрЃў (atomic Retry)|
|5№ИЈРЃБ **Recommended for**|рЃЏрЃљрЃарЃбрЃўрЃЋрЃў, рЃћрЃарЃЌрЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃљрЃюрЃў рЃЮрЃърЃћрЃарЃљрЃфрЃўрЃћрЃЉрЃў|Outbox, Batch updates, Multiple table changes|

---

## ­ЪДа рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃў рЃарЃћрЃљрЃџрЃБрЃарЃў рЃАрЃфрЃћрЃюрЃљрЃарЃўрЃЌ

рЃЊрЃљрЃЋрЃБрЃерЃЋрЃљрЃЌ рЃњрЃљрЃЦрЃЋрЃА рЃАрЃљрЃЏрЃў event:

```csharp
evt1 Рєњ evt1.Status = Sent
evt2 Рєњ evt2.Status = Sent
evt3 Рєњ evt3.Status = Sent
```

рЃЊрЃљ рЃерЃћрЃЏрЃЊрЃћрЃњ рЃўрЃФрЃљрЃ«рЃћрЃЉ:

```csharp
await context.SaveChangesAsync();
```

### ­ЪДЕ рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃЋрЃћрЃарЃАрЃўрЃљ:

рЃЌрЃБ commit-рЃўрЃА рЃЊрЃарЃЮрЃА рЃЏрЃЮрЃ«рЃЊрЃљ glitch Рђћ рЃерЃћрЃАрЃљрЃФрЃџрЃЮрЃљ рЃЉрЃљрЃќрЃљрЃерЃў рЃЕрЃљрЃўрЃгрЃћрЃарЃЮрЃА рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃюрЃљрЃгрЃўрЃџрЃў (`evt1`, `evt2`),  
рЃЏрЃљрЃњрЃарЃљрЃЏ Retry рЃЋрЃћрЃа рЃерЃћрЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃА рЃАрЃгрЃЮрЃарЃљрЃЊ, рЃарЃљрЃЊрЃњрЃљрЃю EF рЃЋрЃћрЃа рЃ«рЃЋрЃЊрЃћрЃЉрЃљ commit рЃБрЃЎрЃЋрЃћ рЃЏрЃЮрЃ«рЃЊрЃљ рЃЌрЃБ рЃљрЃарЃљ.

рЃерЃћрЃЊрЃћрЃњрЃў:

> рЃюрЃљрЃгрЃўрЃџрЃЮрЃЉрЃарЃўрЃЋ commit + Retry = рЃљрЃарЃљрЃАрЃарЃБрЃџрЃў consistency.

---

### ­ЪДЕ рЃЏрЃћрЃЮрЃарЃћ рЃЋрЃћрЃарЃАрЃўрЃљ:

Transaction рЃўрЃгрЃДрЃћрЃЉрЃљ Рєњ рЃДрЃЋрЃћрЃџрЃљрЃцрЃћрЃарЃў (`evt1`, `evt2`, `evt3`) рЃћрЃарЃЌрЃўрЃљрЃюрЃљрЃЊ commit-рЃЊрЃћрЃЉрЃљ.  
рЃЌрЃБ glitch рЃЏрЃЮрЃ«рЃЊрЃљ:

- Transaction rollback рЃЏрЃЮрЃ«рЃЊрЃћрЃЉрЃљ
    
- Retry рЃЌрЃљрЃЋрЃўрЃЊрЃљрЃю рЃњрЃљрЃБрЃерЃЋрЃћрЃЉрЃА рЃЏрЃЌрЃћрЃџ рЃърЃарЃЮрЃфрЃћрЃАрЃА
    
- рЃерЃћрЃЊрЃћрЃњрЃў рЃўрЃЦрЃюрЃћрЃЉрЃљ рЃЏрЃЌрЃџрЃўрЃљрЃюрЃљрЃЊ РђюрЃДрЃЋрЃћрЃџрЃљ рЃљрЃю рЃљрЃарЃфрЃћрЃарЃЌрЃўРђЮ (**atomicity**).
    

рЃерЃћрЃЊрЃћрЃњрЃў:

> Retry рЃњрЃљрЃарЃљрЃюрЃбрЃўрЃарЃћрЃЉрЃБрЃџрЃўрЃљ Transaction-рЃЊрЃЮрЃюрЃћрЃќрЃћ = рЃАрЃарЃБрЃџрЃў consistency.

---

## РџЎ№ИЈ рЃбрЃћрЃЦрЃюрЃўрЃЎрЃБрЃарЃў рЃњрЃљрЃюрЃАрЃ«рЃЋрЃљрЃЋрЃћрЃЉрЃљ EF рЃЊрЃЮрЃюрЃћрЃќрЃћ

EF Core-рЃерЃў `ExecutionStrategy` Retry рЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃА **delegate-рЃА рЃЏрЃЌрЃџрЃўрЃљрЃюрЃљрЃЊ рЃЌрЃљрЃЋрЃўрЃЊрЃљрЃю**.

рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃљрЃЊ:

```csharp
await strategy.ExecuteAsync(async () =>
{
    await using var transaction = await context.Database.BeginTransactionAsync(ct);
    await context.SaveChangesAsync(ct);
    await transaction.CommitAsync(ct);
});
```

РъА№ИЈ Retry рЃюрЃўрЃерЃюрЃљрЃЋрЃА:

> "рЃњрЃљрЃўрЃЏрЃћрЃЮрЃарЃћ рЃЌрЃљрЃЋрЃўрЃЊрЃљрЃю рЃћрЃА рЃЏрЃЌрЃћрЃџрЃў delegate Рђћ Transaction рЃЕрЃљрЃЌрЃЋрЃџрЃўрЃЌ".

рЃЏрЃљрЃњрЃарЃљрЃЏ рЃЌрЃБ Transaction рЃљрЃа рЃњрЃўрЃгрЃћрЃарЃўрЃљ (рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃЋрЃћрЃарЃАрЃўрЃљ), EF рЃБрЃЉрЃарЃљрЃџрЃЮрЃЊ рЃўрЃАрЃћрЃЋ рЃњрЃљрЃЏрЃЮрЃўрЃФрЃљрЃ«рЃћрЃЉрЃА `SaveChangesAsync()`-рЃА рЃўрЃЏрЃљрЃЋрЃћ context-рЃќрЃћ, рЃарЃљрЃф рЃБрЃЎрЃЋрЃћ рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ рЃўрЃДрЃЮрЃА **рЃљрЃарЃљрЃЌрЃљрЃюрЃЏрЃўрЃЏрЃЊрЃћрЃЋрЃарЃБрЃџрЃў** рЃЏрЃЊрЃњрЃЮрЃЏрЃљрЃарЃћрЃЮрЃЉрЃљ (рЃЏрЃљрЃњ. рЃќрЃЮрЃњрЃў entity рЃБрЃЎрЃЋрЃћ рЃњрЃљрЃюрЃљрЃ«рЃџрЃЊрЃљ).

---

## ­Ъћњ рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃў "atomic" Retry-рЃўрЃА рЃЦрЃфрЃћрЃЋрЃўрЃА

### рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃЋрЃћрЃарЃАрЃўрЃљ:

```text
[Retry #1] -> SaveChangesAsync()
    РћюРћђРћђ Update Event1 РюЁ
    РћюРћђРћђ Update Event2 РюЁ
    РћюРћђРћђ Commit РЮї (Network timeout)
[Retry #2] -> SaveChangesAsync() рЃўрЃАрЃћрЃЋ рЃўрЃЏрЃљрЃЋрЃћ context-рЃќрЃћ
    РћюРћђРћђ EF рЃЋрЃћрЃа рЃ«рЃЋрЃЊрЃћрЃЉрЃљ commit-рЃўрЃА рЃерЃћрЃЊрЃћрЃњрЃА
    РћюРћђРћђ рЃерЃћрЃАрЃљрЃФрЃџрЃЮрЃљ Duplicate update рЃљрЃю Constraint violation
```

### рЃЏрЃћрЃЮрЃарЃћ рЃЋрЃћрЃарЃАрЃўрЃљ:

```text
[Retry #1] -> Transaction start
    РћюРћђРћђ Update Event1
    РћюРћђРћђ Update Event2
    РћюРћђРћђ Commit РЮї
    РћюРћђРћђ Rollback()
[Retry #2] -> New Transaction start
    РћюРћђРћђ Update Event1
    РћюРћђРћђ Update Event2
    РћюРћђРћђ Commit РюЁ
```

---

## РюЁ рЃЏрЃЮрЃЎрЃџрЃћрЃЊ рЃерЃћрЃ»рЃљрЃЏрЃћрЃЉрЃљ

|рЃљрЃАрЃърЃћрЃЦрЃбрЃў|рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃЋрЃћрЃарЃАрЃўрЃљ|рЃЏрЃћрЃЮрЃарЃћ рЃЋрЃћрЃарЃАрЃўрЃљ|
|---|---|---|
|Transaction control|РЮї рЃљрЃа рЃўрЃДрЃћрЃюрЃћрЃЉрЃА|РюЁ рЃ«рЃћрЃџрЃўрЃЌ рЃерЃћрЃЏрЃЮрЃбрЃљрЃюрЃўрЃџрЃў|
|Atomic Retry|РЮї рЃљрЃарЃљ|РюЁ рЃЊрЃўрЃљрЃ«|
|Partial Commit Risk|Рџа№ИЈ рЃЏрЃљрЃдрЃљрЃџрЃў|­Ъћњ рЃЊрЃљрЃфрЃБрЃџрЃў|
|Recommended|рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃЏрЃљрЃарЃбрЃўрЃЋрЃў SaveChanges()|рЃДрЃЮрЃЋрЃћрЃџрЃЌрЃЋрЃўрЃА Outbox / Batch рЃЮрЃърЃћрЃарЃљрЃфрЃўрЃћрЃЉрЃќрЃћ|
|Consistency level|РђюBest effortРђЮ|РђюExactly-onceРђЮ Semantics|

---

## ­ЪДГ Bottom Line

> **рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃЋрЃћрЃарЃАрЃўрЃљ** = Retry рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ SaveChanges-рЃќрЃћ Рєњ рЃЏрЃљрЃарЃбрЃўрЃЋрЃў, рЃЏрЃљрЃњрЃарЃљрЃЏ рЃљрЃарЃљ transactional-safe.  
> **рЃЏрЃћрЃЮрЃарЃћ рЃЋрЃћрЃарЃАрЃўрЃљ** = Retry рЃЏрЃЮрЃўрЃфрЃљрЃЋрЃА Transaction-рЃА Рєњ рЃАрЃарЃБрЃџрЃљрЃЊ рЃБрЃАрЃљрЃцрЃарЃЌрЃ«рЃЮ рЃЊрЃљ рЃАрЃгрЃЮрЃарЃў enterprise рЃЊрЃЮрЃюрЃћрЃќрЃћ (Outbox, Integration, Batch Updates).
