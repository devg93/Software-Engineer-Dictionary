рЃФрЃљрЃџрЃўрЃљрЃю рЃЎрЃљрЃарЃњрЃў рЃерЃћрЃЎрЃўрЃЌрЃ«рЃЋрЃљ ­Ъњ» Рђћ рЃЊрЃљ рЃќрЃБрЃАрЃбрЃљрЃЊ рЃћрЃ«рЃћрЃЉрЃљ EF Core-рЃўрЃАрЃљ рЃЊрЃљ SQL Server-рЃўрЃА **transactional consistency vs. partial commit** рЃЌрЃћрЃЏрЃљрЃА.  
рЃЏрЃЮрЃЎрЃџрЃћрЃЊ рЃарЃЮрЃЏ рЃњрЃўрЃЌрЃ«рЃарЃљ:

> **рЃЌрЃБ transaction-рЃерЃўрЃњрЃюрЃўрЃЌ рЃарЃљрЃЏрЃћ рЃЕрЃљрЃЋрЃљрЃарЃЊрЃљ (рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃљрЃЊ рЃЏрЃћрЃАрЃљрЃЏрЃћ update)** Рђћ EF рЃЋрЃћрЃа рЃерЃћрЃўрЃюрЃљрЃ«рЃљрЃЋрЃА рЃърЃўрЃарЃЋрЃћрЃџ рЃЮрЃарЃА рЃЊрЃљ рЃЏрЃћрЃАрЃљрЃЏрЃћ рЃЕрЃљрЃЋрЃљрЃарЃЊрЃћрЃА.  
> Transaction **рЃљрЃю рЃДрЃЋрЃћрЃџрЃљрЃцрЃћрЃарЃА рЃЊрЃљрЃљрЃЎрЃЮрЃЏрЃўрЃбрЃћрЃЉрЃА, рЃљрЃю рЃљрЃарЃљрЃцрЃћрЃарЃА** Рђћ рЃерЃБрЃљ рЃњрЃќрЃљрЃќрЃћ partial save рЃљрЃа рЃ«рЃЊрЃћрЃЉрЃљ.

рЃљрЃ«рЃџрЃљ рЃЎрЃў рЃљрЃњрЃўрЃ«рЃАрЃюрЃў рЃбрЃћрЃЦрЃюрЃўрЃЎрЃБрЃарЃљрЃЊ рЃЊрЃљ рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃўрЃЌ Рђћ рЃарЃљрЃбрЃЮрЃЏ рЃЕрЃљрЃюрЃА рЃќрЃЮрЃњрЃ»рЃћрЃа рЃЌрЃўрЃЌрЃЦрЃЮрЃА РђюрЃърЃўрЃарЃЋрЃћрЃџрЃў рЃЮрЃарЃў рЃерЃћрЃўрЃюрЃљрЃ«рЃљ, рЃЏрЃћрЃАрЃљрЃЏрЃћ рЃЋрЃћрЃарЃљРђЮ, рЃЊрЃљ рЃАрЃўрЃюрЃљрЃЏрЃЊрЃЋрЃўрЃџрЃћрЃерЃў рЃарЃљ рЃ«рЃЊрЃћрЃЉрЃљ РђюрЃЎрЃБрЃџрЃўрЃАрЃћрЃЉрЃерЃўРђЮ.

---

## РџЎ№ИЈ рЃарЃЮрЃњрЃЮрЃа рЃЏрЃБрЃерЃљрЃЮрЃЉрЃА EF Core + Transaction

рЃарЃЮрЃфрЃљ рЃерЃћрЃю рЃўрЃФрЃљрЃ«рЃћрЃЉ:

```csharp
await using var transaction = await context.Database.BeginTransactionAsync();

entity1.Status = "Sent";
entity2.Status = "Sent";
entity3.Status = "Sent";

await context.SaveChangesAsync();  // ­ЪЉѕ рЃљрЃЦ рЃўрЃгрЃДрЃћрЃЉрЃљ transaction рЃерЃўрЃњрЃюрЃўрЃЌ

await transaction.CommitAsync();
```

### рЃерЃўрЃњрЃюрЃўрЃЌ EF рЃљрЃЎрЃћрЃЌрЃћрЃЉрЃА:

1. `BEGIN TRANSACTION`
    
2. рЃљрЃњрЃћрЃюрЃћрЃарЃўрЃарЃћрЃЉрЃА SQL рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃА:
    
    ```sql
    UPDATE Entity SET Status='Sent' WHERE Id=1;
    UPDATE Entity SET Status='Sent' WHERE Id=2;
    UPDATE Entity SET Status='Sent' WHERE Id=3;
    ```
    
3. рЃљрЃњрЃќрЃљрЃЋрЃюрЃўрЃА рЃљрЃЏ batch-рЃА рЃАрЃћрЃарЃЋрЃћрЃарЃќрЃћ.
    
4. рЃЌрЃБ рЃћрЃарЃЌ-рЃћрЃарЃЌрЃў рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљ рЃЕрЃљрЃЋрЃљрЃарЃЊрЃљ (рЃЏрЃљрЃњ. рЃЏрЃћрЃАрЃљрЃЏрЃћ рЃерЃћрЃфрЃЊрЃЮрЃЏрЃўрЃЌ), SQL рЃљрЃЏрЃЉрЃЮрЃЉрЃА:
    
    > РђюTransaction in error state.РђЮ
    
5. EF-рЃАрЃљрЃф рЃћрЃЏрЃўрЃбрЃћрЃЉрЃљ exception (`SqlException`), рЃЊрЃљ transaction рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ rollback-рЃќрЃћ рЃњрЃљрЃЊрЃљрЃЊрЃўрЃА.
    
6. рЃерЃћрЃЊрЃћрЃњрЃљрЃЊ:
    
    - рЃљрЃарЃф рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃЮрЃарЃў рЃљрЃа рЃарЃЕрЃћрЃЉрЃљ рЃЉрЃљрЃќрЃљрЃерЃў (rollback-рЃЊрЃћрЃЉрЃљ).
        
    - рЃљрЃарЃф рЃЏрЃћрЃАрЃљрЃЏрЃћ (рЃЋрЃћрЃа рЃАрЃарЃБрЃџрЃЊрЃћрЃЉрЃљ).
        
    - Transaction рЃЏрЃЌрЃџрЃўрЃљрЃюрЃљрЃЊ рЃњрЃљрЃБрЃЦрЃЏрЃЊрЃћрЃЉрЃљ.
        

­ЪЉЅ рЃљрЃЏрЃўрЃбрЃЮрЃЏ Рђћ transaction **рЃљрЃарЃљрЃАрЃЮрЃЊрЃћрЃА рЃўрЃюрЃљрЃ«рЃљрЃЋрЃА рЃюрЃљрЃгрЃўрЃџрЃЮрЃЉрЃарЃўрЃЋ рЃфрЃЋрЃџрЃўрЃџрЃћрЃЉрЃћрЃЉрЃА.**

---

## ­ЪўЋ рЃЏрЃљрЃе рЃарЃљрЃбрЃЮрЃЏ рЃњрЃћрЃЕрЃЋрЃћрЃюрЃћрЃЉрЃљ, рЃЌрЃўрЃЌрЃЦрЃЮрЃА "рЃЮрЃарЃў рЃерЃћрЃўрЃюрЃљрЃ«рЃљ, рЃЏрЃћрЃАрЃљрЃЏрЃћ рЃЋрЃћрЃарЃљ"?

рЃћрЃА рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ рЃЏрЃЮрЃ«рЃЊрЃћрЃА **рЃЮрЃарЃў рЃАрЃ«рЃЋрЃљрЃЊрЃљрЃАрЃ«рЃЋрЃљ рЃерЃћрЃЏрЃЌрЃ«рЃЋрЃћрЃЋрЃўрЃА рЃњрЃљрЃЏрЃЮ**:

### 1№ИЈРЃБ рЃерЃћрЃю рЃљрЃа рЃўрЃДрЃћрЃюрЃћрЃЉ Transaction-рЃА

рЃЌрЃБ `SaveChangesAsync()` рЃўрЃФрЃљрЃ«рЃћрЃЉ рЃДрЃЮрЃЋрЃћрЃџ entity-рЃќрЃћ рЃфрЃљрЃџ-рЃфрЃљрЃџрЃЎрЃћ:

```csharp
await context.SaveChangesAsync(); // 1 entity
await context.SaveChangesAsync(); // 2 entity
await context.SaveChangesAsync(); // 3 entity (crash)
```

рЃЏрЃљрЃерЃўрЃю рЃЎрЃў Рђћ рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃЮрЃарЃў рЃБрЃЎрЃЋрЃћ commit-рЃћрЃЉрЃБрЃџрЃўрЃљ рЃфрЃљрЃџ-рЃфрЃљрЃџрЃЎрЃћ transaction-рЃћрЃЉрЃљрЃЊ (EF рЃЌрЃўрЃЌрЃЮ SaveChanges-рЃќрЃћ рЃ«рЃАрЃюрЃўрЃА рЃЊрЃљ рЃ«рЃБрЃарЃљрЃЋрЃА transaction-рЃА рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ).

РъА№ИЈ рЃерЃћрЃЊрЃћрЃњрЃљрЃЊ:

- рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃЮрЃарЃў **рЃерЃћрЃўрЃюрЃљрЃ«рЃљ**
    
- рЃЏрЃћрЃАрЃљрЃЏрЃћ рЃЕрЃљрЃЋрЃљрЃарЃЊрЃљ
    
- рЃЊрЃљ рЃћрЃА рЃљрЃарЃўрЃА "partial commit" **EF-рЃўрЃА рЃЊрЃЮрЃюрЃћрЃќрЃћ**, рЃљрЃарЃљ SQL-рЃўрЃА.
    

­ЪДЕ рЃњрЃљрЃЏрЃЮрЃАрЃљрЃЋрЃљрЃџрЃў: Transaction рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћ рЃњрЃљрЃарЃћ wrapper-рЃўрЃЌ (рЃарЃЮрЃњрЃЮрЃарЃф рЃќрЃћрЃЏрЃЮрЃЌ рЃњрЃљрЃЕрЃЋрЃћрЃюрЃћ), рЃарЃЮрЃЏ SaveChanges рЃћрЃарЃЌрЃ«рЃћрЃџ рЃерЃћрЃАрЃарЃБрЃџрЃЊрЃћрЃА рЃДрЃЋрЃћрЃџрЃљ рЃћрЃарЃЌрЃўрЃљрЃюрЃљрЃЊ.

---

### 2№ИЈРЃБ ExecutionStrategy Retry-рЃЏрЃљ рЃЌрЃљрЃЋрЃўрЃЊрЃљрЃю рЃњрЃљрЃБрЃерЃЋрЃљ рЃюрЃљрЃгрЃўрЃџрЃЮрЃЉрЃарЃўрЃЋрЃљрЃЊ

рЃЌрЃБ `EnableRetryOnFailure()` рЃњрЃљрЃЦрЃЋрЃА рЃЕрЃљрЃарЃЌрЃБрЃџрЃў рЃЊрЃљ network glitch рЃЏрЃЮрЃ«рЃЊрЃљ commit-рЃўрЃАрЃљрЃА, EF рЃЋрЃћрЃа рЃ«рЃЋрЃЊрЃћрЃЉрЃљ:

> РђюрЃЊрЃљрЃўрЃЊрЃЮ commit рЃЌрЃБ рЃљрЃарЃљ?РђЮ

рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃЮрЃарЃў `UPDATE` рЃБрЃЎрЃЋрЃћ рЃерЃћрЃАрЃарЃБрЃџрЃЊрЃљ, commit рЃЎрЃў рЃњрЃљрЃгрЃДрЃЊрЃљ. Retry рЃЎрЃЋрЃџрЃљрЃЋ рЃАрЃфрЃЊрЃўрЃА рЃЊрЃљ рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ рЃЏрЃћрЃЮрЃарЃћ рЃ»рЃћрЃарЃќрЃћ рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ рЃЊрЃљрЃўрЃГрЃўрЃарЃЮрЃА constraint-рЃќрЃћ.

РъА№ИЈ рЃерЃћрЃЊрЃћрЃњрЃљрЃЊ рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ рЃЕрЃљрЃюрЃЊрЃљ рЃЌрЃўрЃЌрЃЦрЃЮрЃА РђюрЃЮрЃарЃў рЃњрЃљрЃўрЃљрЃарЃљ, рЃЏрЃћрЃАрЃљрЃЏрЃћ рЃљрЃарЃљРђЮ Рђћ рЃЏрЃљрЃњрЃарЃљрЃЏ рЃћрЃА рЃАрЃўрЃюрЃљрЃЏрЃЊрЃЋрЃўрЃџрЃћрЃерЃў transient retry-рЃўрЃА рЃерЃћрЃЊрЃћрЃњрЃўрЃљ, рЃљрЃарЃљ transaction-рЃўрЃА.

­ЪДЕ рЃњрЃљрЃЏрЃЮрЃАрЃљрЃЋрЃљрЃџрЃў: рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћ `ExecutionStrategy.ExecuteAsync()` + Transaction рЃћрЃарЃЌрЃљрЃЊ Рђћ рЃарЃЮрЃЏ retry рЃЏрЃЮрЃ«рЃЊрЃћрЃА рЃЏрЃЌрЃџрЃўрЃљрЃю рЃЉрЃџрЃЮрЃЎрЃќрЃћ, рЃљрЃарЃљ рЃерЃўрЃњрЃюрЃўрЃЌ.

---

## ­ЪДа рЃерЃћрЃ»рЃљрЃЏрЃћрЃЉрЃљ

|рЃАрЃўрЃбрЃБрЃљрЃфрЃўрЃљ|рЃарЃљрЃбрЃЮрЃЏ рЃЕрЃљрЃюрЃА рЃюрЃљрЃгрЃўрЃџрЃЮрЃЉрЃарЃўрЃЋрЃў commit|рЃарЃћрЃљрЃџрЃБрЃарЃљрЃЊ рЃарЃљ рЃ«рЃЊрЃћрЃЉрЃљ|
|---|---|---|
|SaveChanges() рЃДрЃЮрЃЋрЃћрЃџ Entity-рЃќрЃћ|EF рЃДрЃЮрЃЋрЃћрЃџ рЃ»рЃћрЃарЃќрЃћ рЃ«рЃАрЃюрЃўрЃА рЃљрЃ«рЃљрЃџ Transaction-рЃА|рЃЊрЃўрЃљрЃ«, рЃерЃћрЃюрЃљрЃ«рЃљрЃЋрЃА рЃфрЃљрЃџ-рЃфрЃљрЃџрЃЎрЃћ|
|рЃћрЃарЃЌрЃў Transaction, рЃћрЃарЃЌрЃў SaveChanges()|SQL rollback-рЃА рЃљрЃЎрЃћрЃЌрЃћрЃЉрЃА рЃЏрЃЌрЃџрЃўрЃљрЃюрЃљрЃЊ|рЃљрЃарЃљрЃцрЃћрЃарЃў рЃюрЃљрЃгрЃўрЃџрЃЮрЃЉрЃарЃўрЃЋ рЃљрЃа рЃўрЃюрЃљрЃ«рЃћрЃЉрЃљ|
|Retry Enabled + glitch commit-рЃўрЃАрЃљрЃА|Retry-рЃА рЃњрЃљрЃЏрЃЮ рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ рЃЕрЃљрЃюрЃЊрЃћрЃА рЃЮрЃарЃЏрЃљрЃњрЃў рЃљрЃю рЃюрЃљрЃ«рЃћрЃЋрЃљрЃарЃў commit|Retry рЃ«рЃћрЃџрЃљрЃ«рЃџрЃљ transaction-рЃА рЃ«рЃАрЃюрЃўрЃА|

---

## РюЁ рЃарЃЮрЃњрЃЮрЃа рЃБрЃюрЃЊрЃљ рЃўрЃцрЃўрЃЦрЃарЃЮ рЃърЃарЃљрЃЦрЃбрЃўрЃЎрЃљрЃерЃў

|рЃерЃћрЃю рЃљрЃЎрЃћрЃЌрЃћрЃЉ|EF рЃљрЃЎрЃћрЃЌрЃћрЃЉрЃА рЃерЃўрЃњрЃюрЃўрЃЌ|рЃерЃћрЃЊрЃћрЃњрЃў|
|---|---|---|
|`SaveChanges()` рЃДрЃЮрЃЋрЃћрЃџ entity-рЃќрЃћ|рЃЌрЃўрЃЌрЃЮ SaveChanges = рЃфрЃљрЃџрЃЎрЃћ transaction|рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ рЃюрЃљрЃгрЃўрЃџрЃЮрЃЉрЃарЃўрЃЋ рЃЕрЃљрЃўрЃгрЃћрЃарЃЮрЃА|
|`SaveChanges()` рЃДрЃЋрЃћрЃџрЃљ рЃћрЃарЃЌрЃљрЃЊ + Transaction|рЃћрЃарЃЌрЃў transaction|рЃљрЃю рЃДрЃЋрЃћрЃџрЃљрЃцрЃћрЃарЃў рЃЕрЃљрЃўрЃгрЃћрЃарЃћрЃЉрЃљ рЃљрЃю рЃљрЃарЃљрЃцрЃћрЃарЃў|
|ExecutionStrategy + Transaction|Retry-safe commit|Atomic retry Рђћ рЃБрЃАрЃљрЃцрЃарЃЌрЃ«рЃЮ|

---

## ­ЪњА рЃАрЃљрЃБрЃЎрЃћрЃЌрЃћрЃАрЃЮ рЃцрЃЮрЃарЃЏрЃБрЃџрЃљ

рЃДрЃЮрЃЋрЃћрЃџрЃЌрЃЋрЃўрЃА рЃарЃЮрЃфрЃљ рЃЉрЃћрЃЋрЃа рЃЮрЃЉрЃўрЃћрЃЦрЃбрЃА рЃћрЃарЃЌрЃљрЃЊ рЃљрЃЏрЃБрЃерЃљрЃЋрЃћрЃЉ, рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћ рЃћрЃА рЃерЃљрЃЉрЃџрЃЮрЃюрЃў:

```csharp
var strategy = context.Database.CreateExecutionStrategy();
await strategy.ExecuteAsync(async () =>
{
    await using var transaction = await context.Database.BeginTransactionAsync();

    try
    {
        // рЃДрЃЋрЃћрЃџрЃљ рЃфрЃЋрЃџрЃўрЃџрЃћрЃЉрЃљ рЃћрЃарЃЌрЃўрЃљрЃюрЃљрЃЊ
        await context.SaveChangesAsync();

        await transaction.CommitAsync();
    }
    catch
    {
        await transaction.RollbackAsync();
        throw;
    }
});
```

РюЁ рЃљрЃАрЃћ рЃњрЃљрЃарЃљрЃюрЃбрЃўрЃарЃћрЃЉрЃБрЃџрЃў рЃњрЃљрЃЦрЃЋрЃА:

- рЃљрЃю рЃДрЃЋрЃћрЃџрЃљ рЃерЃћрЃўрЃфрЃЋрЃџрЃћрЃЉрЃљ,
    
- рЃљрЃю рЃљрЃарЃфрЃћрЃарЃЌрЃў,
    
- рЃЊрЃљ Retry рЃЏрЃЮрЃ«рЃЊрЃћрЃЉрЃљ рЃЏрЃЌрЃџрЃўрЃљрЃю рЃЉрЃџрЃЮрЃЎрЃќрЃћ, рЃљрЃарЃљ рЃерЃБрЃљрЃерЃў.
    

---

­Ъћџ **рЃЏрЃЮрЃЎрЃџрЃћрЃЊ:**  
рЃЌрЃБ рЃћрЃарЃЌ Transaction-рЃерЃў рЃ«рЃљрЃа Рєњ SQL Server рЃљрЃю рЃДрЃЋрЃћрЃџрЃљрЃцрЃћрЃарЃА commit-рЃА рЃБрЃЎрЃћрЃЌрЃћрЃЉрЃА, рЃљрЃю рЃДрЃЋрЃћрЃџрЃљрЃцрЃћрЃарЃА rollback-рЃА.  
рЃЌрЃБ рЃарЃљрЃЏрЃЊрЃћрЃюрЃўрЃЏрЃћ SaveChanges рЃўрЃФрЃљрЃ«рЃћ рЃфрЃљрЃџ-рЃфрЃљрЃџрЃЎрЃћ Рєњ commit-рЃћрЃЉрЃў рЃюрЃљрЃгрЃўрЃџрЃЮрЃЉрЃарЃўрЃЋ рЃЕрЃљрЃћрЃгрЃћрЃарЃћрЃЉрЃљ, рЃарЃљрЃЊрЃњрЃљрЃю EF рЃЌрЃўрЃЌрЃЮ рЃЮрЃърЃћрЃарЃљрЃфрЃўрЃљрЃќрЃћ transaction-рЃА рЃ«рЃАрЃюрЃўрЃА рЃЊрЃљ рЃ«рЃБрЃарЃљрЃЋрЃА.